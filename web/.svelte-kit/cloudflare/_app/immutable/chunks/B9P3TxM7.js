class i{eventSource=null;handlers=new Set;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=1e3;baseUrl=null;apiSecret=null;connect(e,t){this.eventSource&&this.disconnect(),this.baseUrl=e,this.apiSecret=t||null;const s=t?`${e}/events?secret=${encodeURIComponent(t)}`:`${e}/events`;try{this.eventSource=new EventSource(s),this.eventSource.onopen=()=>{console.log("[SSE] Connected to observatory-backend"),this.reconnectAttempts=0},this.eventSource.onmessage=o=>{try{const c=JSON.parse(o.data);this.notifyHandlers(c)}catch(c){console.error("[SSE] Failed to parse event:",c)}},this.eventSource.onerror=o=>{console.error("[SSE] Connection error:",o),this.handleReconnect()}}catch(o){console.error("[SSE] Failed to create EventSource:",o)}}handleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("[SSE] Max reconnect attempts reached, giving up");return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`[SSE] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.baseUrl&&this.connect(this.baseUrl,this.apiSecret||void 0)},e)}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null)}subscribe(e){return this.handlers.add(e),()=>{this.handlers.delete(e)}}notifyHandlers(e){for(const t of this.handlers)try{t(e)}catch(s){console.error("[SSE] Handler error:",s)}}get isConnected(){return this.eventSource?.readyState===EventSource.OPEN}get connectionStatus(){const e=this.eventSource?.readyState??-1,t=e===0?"Connecting":e===1?"Connected":e===2?"Closed":"Not initialized";return{connected:e===EventSource.OPEN,connecting:e===EventSource.CONNECTING,url:this.baseUrl,reconnectAttempts:this.reconnectAttempts,maxReconnectAttempts:this.maxReconnectAttempts,readyState:e,readyStateText:t}}}const l=new i,r="orchon-statuses",a="orchon-statuses-timestamp";function h(){try{const n=localStorage.getItem(r),e=localStorage.getItem(a);if(!n||!e)return null;const t=JSON.parse(n),s=parseInt(e,10);return{statuses:t.statuses,lastUpdated:t.lastUpdated,timestamp:s}}catch{return null}}function S(n,e){try{localStorage.setItem(r,JSON.stringify({statuses:n,lastUpdated:e})),localStorage.setItem(a,String(Date.now()))}catch{}}export{l as a,h as g,S as s};
